YUI.add("photo-card-helper",function(e,t){e.mix({langBundles:["common","feed","feed-new"]},e.Localizable);var a=require("justified-layout");e.PhotoCardHelper=function(t){var i={layoutValues:{large:{BATCH_CARD_SPACING:4,BATCH_TARGET_ROW_HEIGHT:150,BATCH_TARGET_ROW_HEIGHT_TOLERANCE:.3,BATCH_ROW_HEIGHT_RATIO:.5},medium:{BATCH_CARD_SPACING:4,BATCH_TARGET_ROW_HEIGHT_TOLERANCE:.3},compact:{BATCH_CARD_SPACING:8,BATCH_TARGET_ROW_HEIGHT:180,BATCH_TARGET_ROW_HEIGHT_TOLERANCE:.3,SINGLE_PHOTO_HEIGHT:250}},ATTRIBUTION_HEADER_HEIGHT:58,DETAILS_FOOTER_HEIGHT:70,INFO_BAR_HEIGHT:52,MAX_PHOTO_AR:2.5,MIN_PHOTO_AR:.5,MANUAL_PORTRAIT_AR:.75,MANUAL_LANDSCAPE_AR:2,getCappedPhotoHeight:function(e){e.height;return Math.min(e.height,Math.max(t.viewportData.getHeight()*e.viewportProportion-e.additionalCardHeight,e.minHeight))},getClampedPhotoAspectRatio:function(e){return Math.min(Math.max(e,this.MIN_PHOTO_AR),this.MAX_PHOTO_AR)},generateCompactBatchLayout:function(e){var t,i=this,o=[],u=1===e.photoItems.length?this.layoutValues.compact.SINGLE_PHOTO_HEIGHT:this.layoutValues.compact.BATCH_TARGET_ROW_HEIGHT;o=e.photoItems.map(function(e){return i.getClampedPhotoAspectRatio(e.aspectRatio)}),(t=a(o,{containerWidth:e.width,containerPadding:0,boxSpacing:{horizontal:this.layoutValues.compact.BATCH_CARD_SPACING,vertical:this.layoutValues.compact.BATCH_CARD_SPACING},targetRowHeight:u,targetRowHeightTolerance:this.layoutValues.compact.BATCH_TARGET_ROW_HEIGHT_TOLERANCE})).width=e.width;var s=t.boxes[0].top,l=[0],n=0;return t.boxes.some(function(e,a){if(e.top>s){if(n+=t.boxes[l[l.length-1]].height+i.layoutValues.compact.BATCH_CARD_SPACING,l.push(a),l.length>3)return!0;s=e.top}}),l.length>3&&(t.boxes=t.boxes.slice(0,l[l.length-1]),t.containerHeight=n),t},generateThreeMaxLayout:function(e){var a=this,i={},o=[],u=[],s=e.photoItems.length;return u=e.photoItems.map(function(e){return a.getClampedPhotoAspectRatio(e.aspectRatio)}),2===(u=u.slice(0,3)).length?u[0]>1&&u[1]>1?(o.push(u.slice(0,1)),o.push(u.slice(1,2)),i=this.buildCustomRowsLayout(o,e)):(o.push(u.slice(0,2)),i=this.buildCustomRowsLayout(o,e)):3===u.length&&(u[0]>1&&u[1]>1&&u[2]>1?(o.push(u.slice(0,1)),o.push(u.slice(1,3)),i=this.buildCustomRowsLayout(o,e)):u[0]>1&&u[1]>1&&u[2]<=1?(o.push(u.slice(0,1)),o.push(u.slice(1,3)),i=this.buildCustomRowsLayout(o,e)):u[0]>1&&u[1]<=1&&u[2]>1?(o.push(u.slice(0,1)),o.push(u.slice(1,3)),i=this.buildCustomRowsLayout(o,e)):u[0]>1&&u[1]<=1&&u[2]<=1?(o.push(u.slice(0,1)),o.push(u.slice(1,3)),i=this.buildCustomRowsLayout(o,e)):u[0]<=1&&u[1]>1&&u[2]>1?(s>3?o.push(u.slice(0,2)):(o.push(u.slice(0,2)),o.push(u.slice(2,3))),i=this.buildCustomRowsLayout(o,e)):u[0]<=1&&u[1]>1&&u[2]<=1?(o.push(u.slice(0,2)),i=this.buildCustomRowsLayout(o,e)):u[0]<=1&&u[1]<=1&&u[2]>1?(s>3?o.push(u.slice(0,2)):(o.push(u.slice(0,2)),o.push(u.slice(2,3))),i=this.buildCustomRowsLayout(o,e)):u[0]<=1&&u[1]<=1&&u[2]<=1&&(o.push(u.slice(0,3)),i=this.buildCustomRowsLayout(o,e))),Math.max.apply(Math,i.boxes.map(function(e){return e.height}))>.8*t.viewportData.getHeight()&&((o=[]).push(u.slice(0,2)),i=this.buildCustomRowsLayout(o,e)),i},buildCustomRowsLayout:function(e,t){var a=this,i=0,o={boxes:[]};return e.forEach(function(u,s){var l={horizontal:a.layoutValues.large.BATCH_CARD_SPACING,vertical:a.layoutValues.large.BATCH_CARD_SPACING},n=a.generateCustomJustifiedRow(u,{containerWidth:t.width,padding:l.horizontal,top:0===s?0:i});o.boxes=o.boxes.concat(n),i+=s!==e.length-1?n[0].height+l.vertical:n[0].height}),o.containerHeight=i,o},generateCustomJustifiedRow:function(e,t){var a=e.reduce(function(e,t,a){return e+t},0),i=(t.containerWidth-t.padding*(e.length-1))/a,o=0;return e.map(function(e,a){var u=o;return o+=i*e+t.padding,{aspectRatio:e,width:i*e,height:i,left:u,top:t.top}})},scaleLayout:function(e,t,a,i,o){var u,s=0,l=0,n=[];return e.boxes.forEach(function(e,a){i||(e.width*=t,e.left*=t),o||(e.height*=t,e.top*=t)}),n.push([]),e.boxes.forEach(function(e,t){e.top>l&&(s++,l=e.top,n.push([])),n[s].push(e)}),u=0,n.forEach(function(s,l){var h=a,r=h*t,g=0;s.forEach(function(e,t){i||(e.width-=(h-r)*(s.length-1)/s.length,e.left=g+t*h,g+=e.width),o||(e.height-=(h-r)*(n.length-1)/n.length,e.top=u+l*h,t===s.length-1&&(u+=s[0].height))}),i||(e.width=g+(s.length-1)*h)}),o||(e.containerHeight=u+(n.length-1)*a),e},convertPhotoModel:function(t){var a,i=t.getValue("owner"),o=t.getValue("engagement"),u=i.getValue("isPro");return"photo-lite-models"===t.registry.name?(a=this.convertEngagementModel(t),{id:e.guid(),layoutRenderType:"photo",photoId:t.getValue("id"),aspectRatio:t.getValue("aspectRatio"),sizes:t.getValue("sizes"),url:t.getValue("url"),title:t.getValue("title"),description:t.getValue("description"),mediaType:t.getValue("mediaType"),isVideo:t.getValue("isVideo"),owner:{nsid:i.getValue("nsid"),url:i.getValue("url"),displayname:i.getValue("displayname"),pathAlias:i.getValue("pathAlias"),isPro:u,proBadgeType:u?i.getValue("proBadge"):void 0,model:t.getValue("owner")},engagement:a,isOwner:t.getValue("isOwner"),needsInterstitial:t.getValue("needsInterstitial"),model:t,engagementModel:o}):(a=this.convertEngagementModel(o),{id:e.guid(),layoutRenderType:"photo",photoId:t.getValue("id"),aspectRatio:t.getValue("aspectRatio"),sizes:t.getValue("sizes"),url:t.getValue("url"),title:t.getValue("title"),description:t.getValue("description"),mediaType:t.getValue("mediaType"),isVideo:t.getValue("isVideo"),owner:{nsid:i.getValue("nsid"),url:i.getValue("url"),displayname:i.getValue("displayname"),buddyicon:i.getValue("buddyicon"),pathAlias:i.getValue("pathAlias"),isPro:u,proBadgeType:u?i.getValue("proBadge"):void 0,model:t.getValue("owner")},engagement:a,isOwner:t.getValue("isOwner"),needsInterstitial:t.getValue("needsInterstitial"),safetyLevel:t.getValue("safetyLevel"),model:t,engagementModel:o})},convertEngagementModel:function(e){return"photo-lite-models"===e.registry.name?{photoId:e.getValue("id"),isFaved:e.getValue("isFaved"),faveCount:e.getValue("faveCount"),commentCount:e.getValue("commentCount"),canFave:e.getValue("canFave"),reactions:t.flipper.isFlipped("enable-likes")?e.getValue("reactions"):void 0,model:e}:{photoId:e.getValue("id"),isFaved:e.getValue("isFaved"),faveCount:e.getValue("faveCount"),commentCount:e.getValue("commentCount"),viewCount:e.getValue("viewCount"),canFave:e.getValue("canFave"),reactions:t.flipper.isFlipped("enable-likes")?e.getValue("reactions"):void 0,model:e}}};return e.augment(i,e.EventTarget),i}},"@VERSION@",{requires:["event-custom","storage-helper"]});YUI.add("like-engagement-item-view",function(e,i){var t=require("hermes-core/flog")(i);e.namespace("Views")[this.name]=e.Base.create("like-engagement-item-view",e.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(i){this.set("isActiveViewAgnostic",!0),this.config=this.processParams(i),this.photoCardHelper=new e.PhotoCardHelper(this.appContext),this.likesHelper=new e.LikesHelper(this.appContext,{}),this.signedIn=this.appContext.getViewer().signedIn},processParams:function(e){return e=Object.assign({engagementModelName:"photo-engagement-models"},e,e.subviewParams?e.subviewParams["like-engagement-item-view"]:{}),{photoId:e.photoId,theme:e.theme,showCount:e.showCount,size:e.size,isPadded:e.isPadded,engagementModelName:e.engagementModelName}},loadState:function(){var e=this;return this.appContext.getModel(this.config.engagementModelName,this.config.photoId).then(function(i){e.engagementModel=i})},buildContainer:function(){this.setContainerWithTemplate("like-engagement-item",Object.assign({engagement:this.photoCardHelper.convertEngagementModel(this.engagementModel)},this.config))},activate:function(){var e=this,i=this.get("container");this.likeNode=i.one(".like-engagement-item"),this.countNode=this.likeNode.one(".like-engagement-count"),this.registerEventHandler(this.likeNode.on("click",this.handleLikeClick.bind(this))),this.registerEventHandler(this.engagementModel.on("valuesChanged",function(i){i.reactions&&e.reload()})),this.fire("activated")},handleLikeClick:function(e){var i=this,n=i.engagementModel,o=n.getValue("reactions").like,s=o.didViewerReact;if(!this.isTogglingLike){if(!(o=this.likesHelper.toggleLikeLocal(!s,{engagementModel:n})))return;this.isTogglingLike=!0,this.likesHelper.updateLikeEngagementItemNode(this.likeNode,o),this.likesHelper.updateReactionRemote({engagementModel:n}).then(function(e){i.isTogglingLike=!1}).catch(function(e){if(i.isTogglingLike=!1,3!==e.code){var o=this.likesHelper.toggleLikeLocal(s,{engagementModel:n});i.likesHelper.updateLikeEngagementItemNode(i.likeNode,o)}t.error("Error liking photo",{err:e}),i.isTogglingLike=!1})}},showCountNode:function(e){this.countNode.toggleClass("hidden",!e)},reload:function(){this.detachRegisteredEvents(),this.buildContainer(),this.activate()}})},"@VERSION@",{requires:["flickr-view","hermes-template-like-engagement-item","likes-helper","photo-card-helper"],langBundles:["common","likes"]});YUI.add("hermes-lang-shared-entity",function(o,e){o.Intl.add("hermes/shared-entity","en-US",{USERNAME_HAS_SHARED_PHOTOS_ONLY:["${username}"," has shared ",{type:"plural",valueName:"photoCount",options:{one:"${#} photo",other:"${#} photos"}}," with you!"],USERNAME_HAS_SHARED_VIDEOS_ONLY:["${username}"," has shared ",{type:"plural",valueName:"videoCount",options:{one:"${#} video",other:"${#} videos"}}," with you!"],USERNAME_HAS_SHARED_PHOTOS_VIDEOS:["${username}"," has shared ",{type:"plural",valueName:"photoCount",options:{one:"${#} photo",other:"${#} photos"}}," ",{type:"plural",valueName:"videoCount",options:{one:"and ${#} video",other:"and ${#} videos"}}," with you!"],OWNER_HAS_SHARED_PHOTOS_ONLY:["You have shared ",{type:"plural",valueName:"photoCount",options:{one:"${#} photo",other:"${#} photos"}},"."],OWNER_HAS_SHARED_VIDEOS_ONLY:["You have shared ",{type:"plural",valueName:"videoCount",options:{one:"${#} video",other:"${#} videos"}},"."],OWNER_HAS_SHARED_PHOTOS_VIDEOS:["You have shared ",{type:"plural",valueName:"photoCount",options:{one:"${#} photo",other:"${#} photos"}}," ",{type:"plural",valueName:"videoCount",options:{one:"and ${#} video",other:"and ${#} videos"}},"."],VIEW_YOUR_SHARING_HISTORY:["View your sharing history"]})},"@VERSION@",{requires:["intl"]});YUI.add("flickr-favorites-getContext-fetcher",function(e,o){"use strict";e.namespace("ListFetchers")["flickr-favorites-getContext"]={run:function(t,s){var r=this;return e.Promise.all([s.callAPI("flickr.favorites.getContext",this._processParams(t),!0),s.getModelRegistry("favorite-models"),s.getModelRegistry("photo-models"),s.getModelRegistry("person-models"),s.getModelRegistry("photo-engagement-models"),s.getModelRegistry("photo-stats-models")]).then(function(e){return r._processResponse(e,t)},function(e){throw 3===e.code&&"Photo not a favorite"===e.message&&(e.notInContext=!0),e}).then(null,e.FetcherErrorLogger(o))},_processParams:function(o){var t={photo_id:o.photoId,num_prev:o.numNext,num_next:o.numPrev,extras:e.APIHelper.request.getRebootPhotoExtras()};return o.id?t.user_id=o.id:t.path_alias=o.pathAlias,t},_processResponse:function(o,t){var s,r,n,a,p,i,l=o[0],h=o[1],d=o[2],g=o[3],u=o[4],m=o[5],c=[],x=[],y=d.proxy(t.photoId),M=[];return s=l.prevphotos,r=l.nextphotos,x=e.APIHelper.response.parsePhotos({photos:s.photo,personModelRegistry:g,photoModelRegistry:d,photoEngagementModelRegistry:u,photoStatsModelRegistry:m}),c=e.APIHelper.response.parsePhotos({photos:r.photo,personModelRegistry:g,photoModelRegistry:d,photoEngagementModelRegistry:u,photoStatsModelRegistry:m}),i=h.getValue(t.id,"photoContextList"),a=!!i.hasMinBoundary&&i.hasMinBoundary(),p=!!i.hasMaxBoundary&&i.hasMaxBoundary(),n=i.getList(),M=e.APIHelper.response.addOrReplaceListByContext({model:y,next:x,prev:c.reverse(),hasMax:p,hasMin:a,current:n,numNext:t.numNext,numPrev:t.numPrev}),h.setValue(t.id,"photoContextList",M),{next:x,previous:c.reverse()}}}},"@VERSION@",{requires:["flickr-promise","api-helper"],optional:["favorite-models","photo-models","person-models","photo-engagement-models","photo-stats-models"]});YUI.add("flickr-favorites-getList-fetcher",function(e,o){"use strict";e.namespace("ListFetchers")["flickr-favorites-getList"]={run:function(t,s){var r=this;return e.Promise.all([s.callAPI("flickr.favorites.getList",this._processParams(t)),s.getModelRegistry("photo-models"),s.getModelRegistry("person-models"),s.getModelRegistry("favorite-models"),s.getModelRegistry("photo-engagement-models"),s.getModelRegistry("photo-stats-models"),s.getModelRegistry("gallery-photo-association-models"),s.getModelRegistry("gallery-faves-models")]).then(function(e){return r._processResponse(e,t)},e.FetcherErrorLogger(o))},_processParams:function(o){var t={extras:e.APIHelper.request.getRebootPhotoExtras(),per_page:o.perPage||20,page:o.page||1,get_user_info:1,jump_to:o.withPhotoId||""};if(o.id||o.userId)t.user_id=(o.id||o.userId).split("-")[0];else{if(!o.pathAlias)throw new Error("[flickr-favorites-getList-fetcher] `id` or `pathAlias` is required.");t.path_alias=o.pathAlias}return o.galleryId&&(t.gallery_id=o.galleryId),t},_processResponse:function(o,t){var s,r,a,p=o[0],l=o[1],i=o[2],d=o[3],g=o[4],h=o[5],n=o[6],y=o[7],c={id:p.user.nsid,pathAlias:p.user.pathAlias,totalItems:p.photos.total},u=t.id||t.userId,f=[];return u&&u!==c.id&&(c.id=u),r=e.APIHelper.response.parsePerson(p.user),c.owner=i.addOrUpdate(r),t.galleryId?(p.photos.photo.forEach(function(e){e.gallerynotaddable&&f.push(e)}),s=e.APIHelper.response.parsePhotos({photos:p.photos.photo,personModelRegistry:i,photoModelRegistry:l,photoEngagementModelRegistry:g,photoStatsModelRegistry:h}),a=e.APIHelper.response.parsePhotos({photos:f,personModelRegistry:i,photoModelRegistry:l,photoEngagementModelRegistry:g,photoStatsModelRegistry:h}),c.photoList={perPage:p.photos.perpage,page:p.photos.page,pageContent:s,totalItems:p.photos.total},c.id=r.id+"-"+t.galleryId,y.addOrUpdate(c).getValue("nonGalleryAddablePhotos").concat(a)):(s=e.APIHelper.response.parsePhotos({photos:p.photos.photo,personModelRegistry:i,photoModelRegistry:l,photoEngagementModelRegistry:g,photoStatsModelRegistry:h}),c.photoPageList={perPage:p.photos.perpage,page:p.photos.page,pageContent:s,totalItems:p.photos.total},d.addOrUpdate(c)),p.photos.photo&&p.photos.photo.forEach(function(e){e.ingallery&&n.addOrUpdate({id:t.galleryId+"-"+e.id,galleryId:t.galleryId,photoId:e.id})}),s}}},"@VERSION@",{requires:["flickr-promise","api-helper"],optional:["photo-models","person-models","favorite-models","photo-engagement-models","photo-stats-models"]});YUI.add("favorite-models",function(e){function t(e){t.superclass.constructor.call(this,e)}e.Models[this.name]=t,e.extend(t,e.FlickrModelRegistry,{name:this.name,remote:{read:function(t){return e.ListFetchers["flickr-favorites-getList"].run(t,this.appContext)}},attributes:{normalizedId:{readOnly:!0,defaultFn:function(e){return e.split("-")[0]}},displayType:{readOnly:!0,defaultFn:function(){return"favorites"}},title:{readOnly:!0,derivedBy:["owner","normalizedId"],defaultFn:function(e){var t,r=this.appContext.getViewer(),i=this.getValue(e,"normalizedId");return r&&r.nsid===i?"Your favorites":(t=this.getValue(e,"owner"))?t.getValue("displayname")+"'s favorites":"Favorites"}},pathAlias:{validator:function(t,r){return e.AttributeHelpers.validateString(t)},setter:function(t){return e.AttributeHelpers.coerceString(t)||void 0},defaultFn:function(e){return this.getValue(e,"normalizedId")}},owner:{isModel:!0},isOwner:e.PhotoModelHelper.attributes.isOwner,photoPageList:{isCollection:!0,pageFetch:{listFetcher:e.ListFetchers["flickr-favorites-getList"]}},photoContextList:{isListProxy:!0,contextFetch:{listFetcher:e.ListFetchers["flickr-favorites-getContext"],listItemIdField:"photoId"}},url:{readOnly:!0,derivedBy:["owner","normalizedId"],defaultFn:function(e){var t=this.getValue(e,"owner"),r=this.getValue(e,"normalizedId");return"/photos/"+(t?t.getValue("pathAlias"):r)+"/favorites/"}},totalItems:{defaultFn:function(){return null}},urlSuffix:{readOnly:!0,derivedBy:["owner"],defaultFn:function(e){return"faves-"+this.getValue(e,"owner").getValue("pathAlias")}}}})},"@VERSION@",{requires:["flickr-model-registry","flickr-promise","flickr-favorites-getContext-fetcher","flickr-favorites-getList-fetcher","photo-model-helper"]});YUI.add("flickr-galleries-getInfo-fetcher",function(e,r){"use strict";e.namespace("ModelFetchers")["flickr-galleries-getInfo"]={run:function(o,t){var n=this,s=this._processParams(o);return e.FlickrPromise({apiResponse:t.callAPI("flickr.galleries.getInfo",s),galleryInfoModelRegistry:t.getModelRegistry("gallery-info-models"),personModelRegistry:t.getModelRegistry("person-models")}).then(function(e){return n._processResponse(e,o,t)},e.FetcherErrorLogger(r))},_processResponse:function(e,r,o){var t,n,s=e.apiResponse,i=e.galleryInfoModelRegistry,a=(e.personModelRegistry,e.personModel,s.gallery);if(a)return o.getModel("person-models",a.owner).then(function(e){return n=e,t={id:r.id,compoundId:a.id,owner:n,username:a.username,primaryPhotoId:a.primary_photo_id,dateCreate:parseInt(a.date_create,10),dateUpdate:parseInt(a.date_update,10),photoCount:a.count_photos,videoCount:a.count_videos,viewCount:parseInt(a.count_views,10),commentCount:parseInt(a.count_comments,10),title:a.title._content,description:a.description._content,currentState:a.current_state,primary_photo_server:a.primary_photo_server,primary_photo_farm:a.primary_photo_farm,primary_photo_secret:a.primary_photo_secret},i.addOrUpdate(t)})},_processParams:function(e){return{gallery_id:e.id}}}},"@VERSION@",{requires:["flickr-promise","api-helper","url-helper"],optional:["gallery-info-models","person-models"]});